generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime? @updatedAt

  // relations to listings
  stays       Stay[]       @relation("UserStays")
  experiences Experience[] @relation("UserExperiences")
  events      Event[]      @relation("UserEvents")

  // booking relations
  stayBookings             StayBooking[]             @relation("UserStayBookings")
  experienceBookings       ExperienceBooking[]       @relation("UserExperienceBookings")
  eventBookings            EventBooking[]            @relation("UserEventBookings")
  notifications            Notification[]            @relation("UserNotifications")
  conversationParticipants ConversationParticipant[]
  messages                 Message[]
  reviews                  Review[]
  // misc
  favourites               Favourite[]
  accounts                 Account[]
  listings                 Listing[]
  reservations             Reservation[]
  trips                    Trip[]                    @relation("UserTrips")
  bannerImage              String?
  profileImage             String?
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Listing {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  description   String
  imageSrc      String
  createdAt     DateTime @default(now())
  category      String
  roomCount     Int
  bathroomCount Int
  guestCount    Int
  locationValue String
  userId        String   @db.ObjectId
  price         Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reservation {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  type         String // "stay" | "event" | "experience"
  userId       String  @db.ObjectId
  eventId      String? @db.ObjectId
  stayId       String? @db.ObjectId
  experienceId String? @db.ObjectId

  stay       Stay?       @relation(fields: [stayId], references: [id])
  event      Event?      @relation(fields: [eventId], references: [id])
  experience Experience? @relation(fields: [experienceId], references: [id])
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  note         String?
  tickets      Int?
  participants Int?
  startDate    DateTime?
  endDate      DateTime?

  subtotal    Int?
  serviceFee  Int?
  totalPrice  Int
  cleaningFee Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Event {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String

  category    String
  dateStart   DateTime
  dateEnd     DateTime
  attendees   Int?
  ticketPrice Int
  capacity    Int
  photos      String[]
  country     String
  city        String
  venue       String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  favourites  Favourite[]

  userId       String         @db.ObjectId
  user         User           @relation("UserEvents", fields: [userId], references: [id], onDelete: Cascade)
  reservations Reservation[]
  reviews      Review[]
  bookings     EventBooking[] @relation("EventBookings")

  // relation to trip items
  tripItems TripItem[] @relation("EventTripItems")
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model Experience {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  description   String
  category      String
  duration      String
  price         Int
  rating        Float?
  photos        String[]
  country       String
  city          String
  venue         String?
  highlights    String[]
  availableDays WeekDay[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // relation to host (User)
  host   User   @relation("UserExperiences", fields: [hostId], references: [id])
  hostId String @db.ObjectId

  // opposite side of bookings
  bookings   ExperienceBooking[] @relation("ExperienceBookings")
  favourites Favourite[]
  reviews    Review[]

  // relation to trip items
  tripItems TripItem[] @relation("ExperienceTripItems")

  reservations Reservation[]
}

model Stay {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String
  homeType        String
  photos          String[]
  amenities       String[]
  rules           String[]
  additionalRules String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt

  // relation to host (User)
  host   User   @relation("UserStays", fields: [hostId], references: [id])
  hostId String @db.ObjectId

  // relation to bookings
  bookings StayBooking[] @relation("StayBookings")

  // relation to favourites
  favourites Favourite[]
  reviews    Review[]

  // relation to trip items
  tripItems TripItem[] @relation("StayTripItems")

  // other embedded/related models
  capacity     Capacity?
  address      Address?
  pricing      Pricing?
  availability Availability?
  reservations Reservation[]

  // publishing control
  isPublished Boolean @default(false)
}

model Capacity {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  guests   Int
  bedrooms Int
  beds     Int
  baths    Int

  // relation to Stay (1:1)
  stayId String @unique @db.ObjectId
  stay   Stay   @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model Address {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  country String
  city    String
  line1   String
  lat     Float?
  lng     Float?

  // relation to Stay (1:1)
  stayId String @unique @db.ObjectId
  stay   Stay   @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model Pricing {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  basePrice   Int
  cleaningFee Int
  serviceFee  Int

  // relation to Stay (1:1)
  stayId String @unique @db.ObjectId
  stay   Stay   @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model Availability {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  unavailable DateTime[]

  // relation to Stay (1:1)
  stayId String @unique @db.ObjectId
  stay   Stay   @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model StayBooking {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  user   User   @relation("UserStayBookings", fields: [userId], references: [id])
  userId String @db.ObjectId

  stay   Stay   @relation("StayBookings", fields: [stayId], references: [id])
  stayId String @db.ObjectId

  checkIn  DateTime
  checkOut DateTime
  nights   Int
  guests   Int
  note     String?
  total    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventBooking {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  user   User   @relation("UserEventBookings", fields: [userId], references: [id])
  userId String @db.ObjectId

  event   Event  @relation("EventBookings", fields: [eventId], references: [id])
  eventId String @db.ObjectId

  tickets  Int
  note     String?
  total    Float
  subtotal Float
  service  Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExperienceBooking {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  user   User   @relation("UserExperienceBookings", fields: [userId], references: [id])
  userId String @db.ObjectId

  experience   Experience @relation("ExperienceBookings", fields: [experienceId], references: [id])
  experienceId String     @db.ObjectId

  date   DateTime
  guests Int
  note   String?
  total  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Favourite {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  // User who favourited
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional relations: can favourite a stay, event, or experience
  stayId String? @db.ObjectId
  stay   Stay?   @relation(fields: [stayId], references: [id])

  eventId String? @db.ObjectId
  event   Event?  @relation(fields: [eventId], references: [id])

  experienceId String?     @db.ObjectId
  experience   Experience? @relation(fields: [experienceId], references: [id])

  @@unique([userId, stayId])
  @@unique([userId, eventId])
  @@unique([userId, experienceId])
}

model Trip {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId String @db.ObjectId
  user   User   @relation("UserTrips", fields: [userId], references: [id], onDelete: Cascade)

  items TripItem[]
}

model TripItem {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  type              String // "stay" | "event" | "experience" | "custom"
  status            String    @default("planned") // "planned" | "booked"
  customTitle       String?
  customDescription String?
  customDate        DateTime?
  customLocation    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  tripId String @db.ObjectId
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  // Optional relations to listings
  stayId String? @db.ObjectId
  stay   Stay?   @relation("StayTripItems", fields: [stayId], references: [id])

  eventId String? @db.ObjectId
  event   Event?  @relation("EventTripItems", fields: [eventId], references: [id])

  experienceId String?     @db.ObjectId
  experience   Experience? @relation("ExperienceTripItems", fields: [experienceId], references: [id])
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  type      String
  title     String
  message   String
  date      DateTime @default(now())
  read      Boolean  @default(false)
  iconColor String?
  user      User     @relation("UserNotifications", fields: [userId], references: [id])
}

model Conversation {
  id           String                    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  messages     Message[]
  participants ConversationParticipant[]
}

model ConversationParticipant {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  userId         String       @db.ObjectId
  conversationId String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id])
}

model Message {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String   @db.ObjectId
  senderId       String   @db.ObjectId
  text           String
  time           DateTime @default(now())

  // relations
  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       User         @relation(fields: [senderId], references: [id])
}

model Review {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  stayId String? @db.ObjectId
  stay   Stay?   @relation(fields: [stayId], references: [id])

  eventId String? @db.ObjectId
  event   Event?  @relation(fields: [eventId], references: [id])

  experienceId String?     @db.ObjectId
  experience   Experience? @relation(fields: [experienceId], references: [id])
  reply        Reply?
  // reply Reply[]
}

model Reply {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  message   String
  createdAt DateTime @default(now())
  reviewId  String   @unique @db.ObjectId
  review    Review   @relation(fields: [reviewId], references: [id])
}
