generator client {
  provider = "prisma-client-js"
}

// datasource db {
//   // provider = "mongodb"
//    provider = "postgresql"
//    url      = env("DATABASE_URL")
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  // id             String    @id @default(auto()) @map("_id") @db.ObjectId
  id             Int          @id @default(autoincrement())
  name           String?
  email          String?      @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime?    @updatedAt
  payments       Payment[]
  // relations to listings
  stays          Stay[]       @relation("UserStays")
  experiences    Experience[] @relation("UserExperiences")
  events         Event[]      @relation("UserEvents")

  // booking relations
  stayBookings             StayBooking[]             @relation("UserStayBookings")
  experienceBookings       ExperienceBooking[]       @relation("UserExperienceBookings")
  eventBookings            EventBooking[]            @relation("UserEventBookings")
  notifications            Notification[]            @relation("UserNotifications")
  conversationParticipants ConversationParticipant[]
  messages                 Message[]
  reviews                  Review[]
  // misc
  favourites               Favourite[]
  accounts                 Account[]
  listings                 Listing[]
  // reservations             Reservation[]
  trips                    Trip[]                    @relation("UserTrips")
  bannerImage              String?
  profileImage             String?
  phone                    String?
  bio                      String?
  HostProfile              HostProfile?
}

model HostProfile {
  // id             String   @id @default(auto()) @map("_id") @db.ObjectId
  id     Int  @id @default(autoincrement())
  // userId         String   @unique @db.ObjectId
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  nin                String?   @unique
  ninVerified        Boolean   @default(false)
  verificationStatus String    @default("pending") // pending | verified | rejected
  verificationDate   DateTime?
  businessName       String?
  businessDocument   String?
  createdAt          DateTime  @default(now())
}

model Account {
  // id                String  @id @default(auto()) @map("_id") @db.ObjectId
  id Int @id @default(autoincrement())

  // userId            String  @db.ObjectId
  userId            Int
  type              String
  provider          String
  providerAccountId String
  // refresh_token     String? @db.String
  // access_token      String? @db.String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  // id_token          String? @db.String
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Listing {
  // id            String   @id @default(auto()) @map("_id") @db.ObjectId
  id            Int      @id @default(autoincrement())
  title         String
  description   String
  imageSrc      String
  createdAt     DateTime @default(now())
  category      String
  roomCount     Int
  bathroomCount Int
  guestCount    Int
  locationValue String
  // userId        String   @db.ObjectId
  userId        Int
  price         Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// model Reservation {
//   // id           String  @id @default(auto()) @map("_id") @db.ObjectId
//   id            Int   @id @default(autoincrement())
//   type         String // "stay" | "event" | "experience"
//   // userId       String  @db.ObjectId
//   userId       Int   
//   // eventId      String? @db.ObjectId
//   // stayId       String? @db.ObjectId
//   // experienceId String? @db.ObjectId
//    eventId      Int? 
//   stayId       Int? 
//   experienceId Int? 

//   stay       Stay?       @relation(fields: [stayId], references: [id])
//   event      Event?      @relation(fields: [eventId], references: [id])
//   experience Experience? @relation(fields: [experienceId], references: [id])
//   user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

//   note         String?
//   tickets      Int?
//   participants Int?
//   startDate    DateTime?
//   endDate      DateTime?

//   subtotal    Int?
//   serviceFee  Int?
//   totalPrice  Int
//   cleaningFee Int?
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt
// }

model Event {
  // id          String @id @default(auto()) @map("_id") @db.ObjectId
  id          Int    @id @default(autoincrement())
  title       String
  description String

  category    String
  dateStart   DateTime
  dateEnd     DateTime
  attendees   Int?
  ticketPrice Int
  capacity    Int
  photos      String[]
  country     String
  city        String
  venue       String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  favourites  Favourite[]

  // userId       String         @db.ObjectId
  userId   Int
  user     User           @relation("UserEvents", fields: [userId], references: [id], onDelete: Cascade)
  // reservations Reservation[]
  reviews  Review[]
  bookings EventBooking[] @relation("EventBookings")

  // relation to trip items
  tripItems TripItem[] @relation("EventTripItems")
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model Experience {
  // id            String    @id @default(auto()) @map("_id") @db.ObjectId
  id            Int       @id @default(autoincrement())
  title         String
  description   String
  category      String
  duration      String
  price         Int
  rating        Float?
  photos        String[]
  country       String
  city          String
  venue         String?
  highlights    String[]
  availableDays WeekDay[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // relation to host (User)
  host   User @relation("UserExperiences", fields: [hostId], references: [id])
  hostId Int  

  // opposite side of bookings
  bookings   ExperienceBooking[] @relation("ExperienceBookings")
  favourites Favourite[]
  reviews    Review[]

  // relation to trip items
  tripItems TripItem[] @relation("ExperienceTripItems")

  // reservations Reservation[]
}

model Stay {
  // id              String    @id @default(auto()) @map("_id") @db.ObjectId
  id              Int       @id @default(autoincrement())
  title           String
  description     String
  homeType        String
  photos          String[]
  amenities       String[]
  rules           String[]
  additionalRules String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt

  // relation to host (User)
  host   User @relation("UserStays", fields: [hostId], references: [id])
  // hostId String @db.ObjectId
  hostId Int  

  // relation to bookings
  bookings StayBooking[] @relation("StayBookings")

  // relation to favourites
  favourites Favourite[]
  reviews    Review[]

  // relation to trip items
  tripItems TripItem[] @relation("StayTripItems")

  // other embedded/related models
  capacity     Capacity?
  address      Address?
  pricing      Pricing?
  availability Availability?
  // reservations Reservation[]

  // publishing control
  isPublished Boolean @default(false)
}

model Capacity {
  // id       String @id @default(auto()) @map("_id") @db.ObjectId
  id       Int @id @default(autoincrement())
  guests   Int
  bedrooms Int
  beds     Int
  baths    Int

  // relation to Stay (1:1)
  // stayId String @unique @db.ObjectId
  stayId Int @unique

  stay Stay @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model Address {
  // id      String @id @default(auto()) @map("_id") @db.ObjectId
  id      Int    @id @default(autoincrement())
  country String
  city    String
  line1   String
  lat     Float?
  lng     Float?

  // relation to Stay (1:1)
  // stayId String @unique @db.ObjectId
  stayId Int  @unique
  stay   Stay @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model Pricing {
  // id          String @id @default(auto()) @map("_id") @db.ObjectId
  id          Int @id @default(autoincrement())
  basePrice   Int
  cleaningFee Int
  serviceFee  Int

  // relation to Stay (1:1)
  // stayId String @unique @db.ObjectId
  stayId Int  @unique
  stay   Stay @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model Availability {
  // id          String     @id @default(auto()) @map("_id") @db.ObjectId
  id          Int        @id @default(autoincrement())
  unavailable DateTime[]

  // relation to Stay (1:1)
  // stayId String @unique @db.ObjectId
  stayId Int  @unique
  stay   Stay @relation(fields: [stayId], references: [id], onDelete: Cascade)
}

model StayBooking {
  id     Int  @id @default(autoincrement())

  user   User @relation("UserStayBookings", fields: [userId], references: [id])
  userId Int

  stay   Stay @relation("StayBookings", fields: [stayId], references: [id])
  stayId Int

  paymentStatus PaymentStatus @default(PENDING)

  checkIn  DateTime
  checkOut DateTime
  nights   Int
  guests   Int
  note     String?
  total    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stayId])
  @@index([userId])
}

model EventBooking {
  // id String @id @default(auto()) @map("_id") @db.ObjectId
  id     Int  @id @default(autoincrement())
  user   User @relation("UserEventBookings", fields: [userId], references: [id])
  // userId String @db.ObjectId
  userId Int

  event   Event @relation("EventBookings", fields: [eventId], references: [id])
  eventId Int

  paymentStatus PaymentStatus @default(PENDING)

  tickets  Int
  note     String?
  total    Int
  subtotal Int
  service  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExperienceBooking {
  // id String @id @default(auto()) @map("_id") @db.ObjectIds
  id Int @id @default(autoincrement())

  user   User @relation("UserExperienceBookings", fields: [userId], references: [id])
  userId Int

  experience   Experience @relation("ExperienceBookings", fields: [experienceId], references: [id])
  experienceId Int

  date          DateTime
  guests        Int
  note          String?
  subtotal      Int
  service       Int
  total         Int
  paymentStatus PaymentStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Favourite {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // User who favourited
  // 1. REMOVE @unique from here
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional relations
  // 2. REMOVE @unique from these as well. 
  // (Multiple users should be able to like the same stay!)
  stayId Int?
  stay   Stay? @relation(fields: [stayId], references: [id])

  eventId Int?
  event   Event? @relation(fields: [eventId], references: [id])

  experienceId Int?
  experience   Experience? @relation(fields: [experienceId], references: [id])

  // 3. KEEP THESE
  // These valid composite constraints prevent a user from liking 
  // the exact same item twice, which is what you want.
  @@unique([userId, stayId])
  @@unique([userId, eventId])
  @@unique([userId, experienceId])
}

model Trip {
  // id          String    @id @default(auto()) @map("_id") @db.ObjectId,
  id Int @id @default(autoincrement())

  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  destination String?
  duration    Int?
  budget      Int?
  interests   String[]
  description String?
  vibe        String?
  itinerary   Json?
  // createdAt    DateTime @default(now())
  // userId Int? @unique 
  userId      Int
  user        User     @relation("UserTrips", fields: [userId], references: [id], onDelete: Cascade)

  items TripItem[]
}

model TripItem {
  // id                String    @id @default(auto()) @map("_id") @db.ObjectId
  id Int @id @default(autoincrement())

  type              String // "stay" | "event" | "experience" | "custom"
  status            String    @default("planned") // "planned" | "booked"
  customTitle       String?
  customDescription String?
  customDate        DateTime?
  customLocation    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  tripId Int
  trip   Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  // Optional relations to listings
  stayId Int?
  stay   Stay? @relation("StayTripItems", fields: [stayId], references: [id])

  eventId Int?
  event   Event? @relation("EventTripItems", fields: [eventId], references: [id])

  experienceId Int?
  experience   Experience? @relation("ExperienceTripItems", fields: [experienceId], references: [id])
}

model Notification {
  // id        String   @id @default(auto()) @map("_id") @db.ObjectId
  id        Int      @id @default(autoincrement())
  userId    Int      
  type      String
  title     String
  message   String
  date      DateTime @default(now())
  read      Boolean  @default(false)
  iconColor String?
  user      User     @relation("UserNotifications", fields: [userId], references: [id])
}

model Conversation {
  // id           String                    @id @default(auto()) @map("_id") @db.ObjectId
  id Int @id @default(autoincrement())

  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  messages     Message[]
  participants ConversationParticipant[]
}

model ConversationParticipant {
  id Int @id @default(autoincrement())

  userId         Int
  conversationId Int

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId]) // âœ… composite unique
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id Int @id @default(autoincrement())

  conversationId Int
  senderId       Int
  text           String
  createdAt      DateTime @default(now())

  // relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
}

model Review {
  // id        String   @id @default(auto()) @map("_id") @db.ObjectId
  id Int @id @default(autoincrement())

  user      User     @relation(fields: [userId], references: [id])
  userId    Int      
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  stayId Int?  
  stay   Stay? @relation(fields: [stayId], references: [id])

  eventId Int?   
  event   Event? @relation(fields: [eventId], references: [id])

  experienceId Int?        
  experience   Experience? @relation(fields: [experienceId], references: [id])
  reply        Reply?
  @@unique([userId, stayId])
  @@unique([userId, eventId])
  @@unique([userId, experienceId])
  // reply Reply[]
}

model Reply {
  // id        String   @id @default(auto()) @map("_id") @db.ObjectId
  id Int @id @default(autoincrement())

  message   String
  createdAt DateTime @default(now())
  reviewId  Int      @unique
  review    Review   @relation(fields: [reviewId], references: [id])
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentProvider {
  PAYSTACK
  FLUTTERWAVE
}

model Payment {
  id Int @id @default(autoincrement())

  userId   Int
  amount   Int // amount in kobo (Paystack standard)
  currency String @default("NGN")

  provider     PaymentProvider
  providerRef  String?         @unique // reference from Paystack/Flutterwave
  providerTxId String? // transaction id

  status PaymentStatus @default(PENDING)

  bookingType BookingType
  bookingId   Int // stayBooking / eventBooking / experienceBooking id

  metadata Json? // anything extra from provider

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([bookingType, bookingId])
}

enum BookingType {
  STAY
  EVENT
  EXPERIENCE
}
